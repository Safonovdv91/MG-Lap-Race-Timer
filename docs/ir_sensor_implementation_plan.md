# План реализации ИК сенсоров с модуляцией для таймера SFMgTimer

## Обзор
В данном документе представлен полный план перехода от текущей системы управления через замыкания 3.3В на контакты GPIO14 и GPIO27 к системе с использованием ИК передатчиков и приемников с модуляцией сигнала.

## Текущая система
- Используются GPIO14 и GPIO27 для детектирования замыкания 3.3В
- Обработка прерываний по спадающему фронту (FALLING)
- Работает в трех режимах: SPEEDOMETER, LAP_TIMER, RACE_TIMER
- Использует антидребезг и минимальное время между срабатываниями

## Целевая система
- ИК передатчики с модуляцией 38 кГц
- ИК приемники TSOP38238 с детектированием пересечения луча
- Та же логика обработки событий, но на основе прерываний от ИК приемников

## Последовательность разработки

### Этап 1: Подготовка аппаратной части
1. Приобрести компоненты:
   - 2x TSOP38238 (ИК приемники)
   - 2x ИК светодиоды (например, TSAL6200)
   - Резисторы для ограничения тока ИК диодов
2. Разработать схему подключения
3. Подготовить печатную плату или макетную плату для тестирования

### Этап 2: Реализация программной части
1. Добавить поддержку генерации ШИМ 38 кГц для управления ИК передатчиками
2. Модифицировать обработчики прерываний для работы с ИК приемниками
3. Обеспечить обратную совместимость с возможностью переключения между режимами
4. Добавить диагностику и мониторинг ИК системы

### Этап 3: Интеграция с основной системой
1. Интегрировать ИК сенсоры с текущей системой измерений
2. Проверить работу во всех режимах (SPEEDOMETER, LAP_TIMER, RACE_TIMER)
3. Настроить параметры антидребезга и минимального времени между срабатываниями

### Этап 4: Тестирование и отладка
1. Провести функциональное тестирование
2. Проверить точность измерения времени
3. Тестировать устойчивость к помехам
4. Проверить работу на разных расстояниях

## Архитектурные изменения

### Новые файлы:
- `ir_transmitter.h/cpp` - управление ИК передатчиками
- `ir_receiver.h/cpp` - обработка сигналов от ИК приемников
- Обновленные `config.h`, `measurements.cpp`, `main.cpp`

### Изменения в конфигурации:
- Определение пинов для ИК передатчиков
- Настройка параметров ШИМ для генерации 38 кГц
- Возможные изменения в настройках прерываний

### Изменения в логике:
- Модификация обработчиков прерываний `handleSensor1()` и `handleSensor2()`
- Добавление функций управления ИК передатчиками
- Включение/выключение передатчиков через веб-интерфейс

## Протокол модуляции
- Частота: 38 кГц
- Тип модуляции: ON/OFF ключевание
- Время реакции: < 20 мс
- Антидребезг: 100 мс (настраивается)

## Проверка работоспособности
1. Подача питания на ИК передатчики и приемники
2. Проверка наличия 38 кГц сигнала на передатчиках (через осциллограф или частотомер)
3. Проверка выходного сигнала приемников при наличии и отсутствии луча
4. Проверка регистрации событий пересечения луча в системе
5. Тестирование всех режимов работы таймера

## Резервный план
Если возникнут проблемы с ИК системой, предусмотреть возможность переключения обратно на оригинальную систему с механическими контактами.

## Заключение
Переход на ИК сенсоры с модуляцией обеспечит более надежное и точное детектирование пересечения луча, а также позволит устанавливать датчики на большем расстоянии друг от друга без необходимости прокладки проводов.